# 搜索查询

1. 用户输入搜索内容, 点击搜索。
    1. 下载视频数量作为配置文件的配置项
    2. 拼接视频路径。
    3. 爬取视频
2. 后台自动下载。
3. UI逐条显示下载视频的信息。

```python
def fetch_video_data(video_url, is_from_search=''):
    logger = logging_utils.get_logging('crawler_ixigua')
    video_url = handle_url(video_url)
```

## 搜索下载，如何不重复下载视频

需求：相同搜索条件，连续两次下载5个视频，下载视频不重复，一共下载十个。
方法：遍历搜索内容目录下的所有视频文件名，和下载的视频文件名比较
存在则不下载,直接返回
反之下载

## 西瓜视频特殊情况

西瓜视频会搜索出视频合集。但点进去默认是第一集。可以正常链接下载。

- [ ] 要考虑用户是否要下载整个合集的情况。

# 下载路径问题

1. 根目录为配置文件的目录
2. 如果是搜索下载
   加一级搜索内容目录，目录下放下载的视频和封面
3. 如果是直链下载
   直接将视频和封面保存到根目录下



# 配置项的逻辑

1. 如果有section
    1. 获取对应的值
2. 如果没有section
    1. 赋予默认值
3. 什么时候添加section
    1. UI界面的方法

# 异常处理情况

1. 整个爬取方法嵌套异常try-except
2. 异常捕获后如何提示？
3. 目前已知的异常有
    1. 开梯子
    2. 页面请求后，正则类异常
4. 如果资源下载失败，如何处理
    1. 如果是写入过程中失败了，有失败品，就删除掉失败品。
    2. 如果网页请求失败了，返回状态码

# 任务清单

- [x] 约束链接爬取的链接格式？

    - [x] 抖音可以考虑提取出链接的modal_id，符合能够爬取的格式

    抖音从首页打开视频和从搜索页打开视频，链接格式是不一样的

    - [x] B站只要有BV号即可

    - [x] 西瓜也需要一串数字，但是没有明确的命名。

      经过观察，不管从哪打开视频，链接，前半部分均一致。

- [x] 后端获取的标题、标签等要做非空判断。-----11.9

  如果为空，则赋予初始值。

- [x] 尝试下载B站大会员视频

    爬不了，出于时间和技术问题

- [ ] 优化异常处理

    - [x] 代理异常

      放在readme里面，进行提示。

    - [x] 提供错误链接

      目前异常的处理方式是直接抛，在UI界面捕获，并弹窗提示。

- [x] 封面下载失败如何处理？

    - [x] 如果视频已下载，如何赋值封面下载状态？----要优化避免搜索爬取重复下载方法

      寻找是否有对应的标题名的jpg格式的图片即可。

- [ ] 什么时候避免重复下载？
  - [ ] 对于链接下载，给一个配置项，用户决定。
  - [x] 对于搜索下载，规定不允许重复下载

- [x] 测试复杂搜索内容的搜索爬取效果
    - 掺杂空格，加号，其他特殊符号----》实际上这些特殊字符无伤大雅

- [x] 从网页爬取的封面有可能是损坏的
    - [x] 西瓜视频出现过这种情况
      - 根据分析：爬取的是合集视频，封面图片格式是.avif。win10自带的图片工具，需要下载特定的图片拓展工具才能打开。
      - 下载了图片拓展工具后，后缀是jpg不影响查看图片。
      - 如果系统有自己安装的看图工具，一般都可以打开。

- [ ] 考虑各个视频网站的**合集**视频该如何处理。

- [ ] 测试B站爬取，相同搜索条件，爬7次，每次爬6个，确保符合预期

- [ ] 观察：B站搜索页爬取的video_urls元素顺序是不是固定的。

- [x] 西瓜视频链接爬取，返回的response可能有问题，但是多请求几次又可能没有问题。

    多爬几次，循环爬个7次，还失败就算失败。

- [x] 观察：抖音爬取的视频，一次返回十个，顺序时候和页面一致

    经过观察，是的，是一致的。去掉请求中的round_trip_time参数

- [ ] 考虑一个问题，搜索爬取，视频的排序和时间有关。我目前为了避免重复爬取和追加爬取，都是从一定初始页数开始爬取。默认前面爬取过得不会改变网站搜索显示顺序，实际上是不合理的。

    - [ ] 方案1：文件夹的命名方式在加上日期。不同日期，相同搜索内容，也分目录存储。

    这同时产生了一个新的问题：日期选的不合理（间隔太短），今天爬一次，明天爬一次，可能会大量重复下载。

    - [ ] 方案2：如果还是放在同一个目录，有没有什么办法，可以让程序从0开始爬取，重新筛选一遍。

      这里要考虑一个问题，用户想要什么：可能是当前搜索内容的热门视频（前十个）;可能是一次性批量下载视频；

      我目前实现的多次搜索追加下载，对于‘热门’视频更新的问题不好解决。

- [ ] 长视频下载问题

  用户体验角度：

  - [ ] 下载进度、下载时间的反馈（控制台显示）

- [ ] 切换视频网站后，清空搜索栏


# 使用条件

1. 下载ffmpeg，配置系统环境变量。
1. 使用前关闭代理。
1. 确保网络通畅。
